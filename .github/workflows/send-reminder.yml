name: å®šæ—¶æé†’ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '*/3 * * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ - è¿™ä¸ªå¿…é¡»æœ‰ï¼
  push:
    branches: [ main, master ]
    paths:
      - 'reminders.json'

# æƒé™è®¾ç½® - å…³é”®ï¼
permissions:
  contents: write
  actions: read

jobs:
  check-and-send:
    name: ğŸ”” æ£€æŸ¥å¹¶å‘é€æé†’
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: ğŸ•’ 2. è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          echo "BEIJING_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      
      - name: ğŸ“‹ 3. æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        run: |
          echo "ğŸ”§ GitHub Workspace: ${{ github.workspace }}"
          echo "ğŸ”§ GitHub Repository: ${{ github.repository }}"
          echo "ğŸ”§ GitHub Run ID: ${{ github.run_id }}"
          echo "ğŸ”§ å½“å‰æ—¶é—´: ${{ env.BEIJING_TIME }}"
          echo "ğŸ”§ ä»Šå¤©æ—¥æœŸ: ${{ env.TODAY }}"
          
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“ ä»“åº“æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          
          # æ£€æŸ¥reminders.jsonæ˜¯å¦å­˜åœ¨
          if [ -f "reminders.json" ]; then
            echo "âœ… reminders.json å­˜åœ¨"
            cat reminders.json | head -20
          else
            echo "âŒ reminders.json ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤æ–‡ä»¶"
            echo '[]' > reminders.json
          fi
      
      - name: ğŸ¤– 4. æ£€æŸ¥å¹¶å‘é€Telegramæ¶ˆæ¯
        id: send_message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ” å¼€å§‹æ£€æŸ¥åˆ°æœŸæé†’..."
          
          # æ£€æŸ¥Telegramé…ç½®
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "âŒ é”™è¯¯: TELEGRAM_BOT_TOKEN æœªé…ç½®"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âŒ é”™è¯¯: TELEGRAM_CHAT_ID æœªé…ç½®"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          
          echo "âœ… Telegram Bot Token: ${TELEGRAM_BOT_TOKEN:0:20}..."
          echo "âœ… Telegram Chat ID: $TELEGRAM_CHAT_ID"
          
          # åˆ›å»ºNode.jsè„šæœ¬
          cat > check.js << 'EOF'
          const fs = require('fs');
          const https = require('https');

          // è·å–ç¯å¢ƒå˜é‡
          const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
          const CHAT_ID = process.env.TELEGRAM_CHAT_ID;
          const TODAY = process.env.TODAY;
          const REPO = process.env.GITHUB_REPOSITORY;
          const RUN_ID = process.env.GITHUB_RUN_ID;

          console.log('='.repeat(50));
          console.log('ğŸ“… ä»Šå¤©æ—¥æœŸ:', TODAY);
          console.log('='.repeat(50));

          // è¯»å–æé†’æ•°æ®
          let reminders = [];
          try {
            if (fs.existsSync('reminders.json')) {
              const content = fs.readFileSync('reminders.json', 'utf8');
              reminders = JSON.parse(content);
              console.log(`ğŸ“‹ æˆåŠŸåŠ è½½ ${reminders.length} ä¸ªæé†’`);
            } else {
              console.log('ğŸ“ reminders.json ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶');
              fs.writeFileSync('reminders.json', '[]');
            }
          } catch (e) {
            console.error('âŒ è¯»å–æ–‡ä»¶å¤±è´¥:', e.message);
            process.exit(1);
          }

          // ç­›é€‰ä»Šå¤©åˆ°æœŸçš„æé†’
          const dueReminders = reminders.filter(r => 
            r.enabled !== false && 
            r.nextReminder === TODAY &&
            r.notified !== true
          );

          console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸæé†’: ${dueReminders.length} ä¸ª`);

          if (dueReminders.length === 0) {
            console.log('âœ… æ²¡æœ‰éœ€è¦å‘é€çš„æé†’');
            process.exit(0);
          }

          // æ˜¾ç¤ºå³å°†å‘é€çš„æé†’
          dueReminders.forEach((r, i) => {
            console.log(`   ${i+1}. ${r.name} - åˆ°æœŸ: ${r.nextReminder}`);
          });

          // å‘é€Telegramæ¶ˆæ¯
          function sendMessage(reminder) {
            return new Promise((resolve, reject) => {
              // è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
              const nextDate = new Date(TODAY);
              nextDate.setDate(nextDate.getDate() + reminder.days);
              const nextYear = nextDate.getFullYear();
              const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
              const nextDay = String(nextDate.getDate()).padStart(2, '0');
              const nextReminder = `${nextYear}-${nextMonth}-${nextDay}`;

              // æ„å»ºæ¶ˆæ¯
              const message = `ğŸ”” <b>å®šæ—¶æé†’é€šçŸ¥</b>%0A%0A` +
                `ğŸ“Œ <b>ä»»åŠ¡</b>: ${reminder.name}%0A` +
                `ğŸ“… <b>åˆ°æœŸæ—¥æœŸ</b>: ${reminder.nextReminder}%0A` +
                `â³ <b>å‘¨æœŸ</b>: æ¯ ${reminder.days} å¤©%0A` +
                `âœ… <b>ä¸Šæ¬¡å®Œæˆ</b>: ${reminder.lastUpdated || 'æ— '}%0A` +
                `ğŸ”„ <b>ä¸‹æ¬¡æé†’</b>: ${nextReminder}%0A%0A` +
                `âš ï¸ <b>è¯·åŠæ—¶å¤„ç†ï¼</b>%0A%0A` +
                `â° æ£€æŸ¥æ—¶é—´: ${process.env.BEIJING_TIME}%0A` +
                `ğŸ”— <a href='https://github.com/${REPO}/actions/runs/${RUN_ID}'>æŸ¥çœ‹è¿è¡Œæ—¥å¿—</a>`;

              const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${message}&parse_mode=HTML&disable_web_page_preview=true`;
              
              https.get(url, (res) => {
                let data = '';
                res.on('data', (chunk) => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    if (result.ok) {
                      console.log(`âœ… å‘é€æˆåŠŸ: ${reminder.name}`);
                      reminder.notified = true;
                      reminder.lastSentTime = new Date().toISOString();
                      resolve(true);
                    } else {
                      console.error(`âŒ å‘é€å¤±è´¥: ${reminder.name}`, result.description);
                      resolve(false);
                    }
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on('error', reject);
            });
          }

          // ä¾æ¬¡å‘é€
          (async () => {
            let success = 0;
            for (const reminder of dueReminders) {
              try {
                if (await sendMessage(reminder)) success++;
                await new Promise(r => setTimeout(r, 1000));
              } catch (e) {
                console.error(`âŒ é”™è¯¯: ${reminder.name}`, e.message);
              }
            }
            
            // ä¿å­˜æ›´æ–°
            fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
            console.log(`ğŸ’¾ å·²ä¿å­˜æ›´æ–°ï¼ŒæˆåŠŸ: ${success}/${dueReminders.length}`);
            
            if (success > 0) {
              fs.writeFileSync('has-updates.txt', 'true');
            }
          })().catch(console.error);
          EOF

          # æ‰§è¡Œè„šæœ¬
          node check.js
      
      - name: ğŸ’¾ 5. æäº¤æ›´æ–°åˆ°ä»“åº“
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git add reminders.json
          
          if ! git diff --quiet && ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æé†’çŠ¶æ€ [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
      
      - name: ğŸ“¢ 6. å‘é€æµ‹è¯•æˆåŠŸé€šçŸ¥
        if: success() && github.event_name == 'workflow_dispatch'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="âœ… GitHub Actions æ‰‹åŠ¨æµ‹è¯•æˆåŠŸï¼%0Aâ° æ—¶é—´: ${{ env.BEIJING_TIME }}%0AğŸ“¦ ä»“åº“: ${{ github.repository }}" \
            -d parse_mode="HTML" || echo "å‘é€é€šçŸ¥å¤±è´¥"
