name: å®šæ—¶æé†’ç³»ç»Ÿ Â· é£æœºAPIç»‘å®šç‰ˆ

on:
  schedule:
    # æ¯3åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´) -> åŒ—äº¬æ—¶é—´æ¯3åˆ†é’Ÿ
    - cron: '*/3 * * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'reminders.json'  # æé†’æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘
  pull_request:
    paths:
      - 'reminders.json'

# èµ‹äºˆå·¥ä½œæµå¿…è¦çš„æƒé™
permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write

jobs:
  check-and-notify:
    name: ğŸ”” æ£€æŸ¥åˆ°æœŸæé†’å¹¶å‘é€é£æœºæ¶ˆæ¯
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 1

      - name: ğŸ•’ è®¾ç½®åŒ—äº¬æ—¶é—´
        run: |
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          echo "BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "TODAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: ğŸ“Š è¯»å–å¹¶æ£€æŸ¥æé†’
        id: check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "â° åŒ—äº¬æ—¶é—´: ${{ env.BEIJING_TIME }}"
          echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: ${{ env.TODAY }}"
          
          # å¦‚æœæ²¡æœ‰reminders.jsonåˆ™åˆ›å»º
          if [ ! -f "reminders.json" ]; then
            echo '[]' > reminders.json
            echo "ğŸ“ åˆ›å»ºç©ºæé†’æ–‡ä»¶"
          fi
          
          # ä½¿ç”¨Node.jså¤„ç†æé†’é€»è¾‘
          node -e "
          const fs = require('fs');
          
          // ---------- é…ç½®éªŒè¯ ----------
          const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
          const CHAT_ID = process.env.TELEGRAM_CHAT_ID;
          const TODAY = process.env.TODAY;
          
          if (!BOT_TOKEN || !CHAT_ID) {
            console.error('âŒ é”™è¯¯: æœªé…ç½®Telegramå‡­è¯');
            console.error('è¯·åœ¨Settings â†’ Secrets â†’ Actionsä¸­æ·»åŠ :');
            console.error('  - TELEGRAM_BOT_TOKEN: ä½ çš„Bot Token');
            console.error('  - TELEGRAM_CHAT_ID: ç¾¤ç»„/ç”¨æˆ·ID');
            process.exit(1);
          }
          
          console.log('âœ… Telegramå‡­è¯å·²é…ç½®');
          console.log('ğŸ¤– Bot Token:', BOT_TOKEN.substring(0, 20) + '...');
          console.log('ğŸ‘¥ Chat ID:', CHAT_ID);
          
          // ---------- è¯»å–æé†’æ•°æ® ----------
          let reminders = [];
          try {
            const content = fs.readFileSync('reminders.json', 'utf8');
            reminders = JSON.parse(content);
            console.log('ğŸ“‹ å·²åŠ è½½æé†’æ•°é‡:', reminders.length);
          } catch(e) {
            console.log('âš ï¸ æé†’æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
            reminders = [];
          }
          
          // ---------- ç­›é€‰åˆ°æœŸæé†’ ----------
          const dueReminders = reminders.filter(r => 
            r.enabled !== false && 
            r.nextReminder === TODAY &&
            r.notified !== true
          );
          
          console.log('ğŸ” ä»Šæ—¥åˆ°æœŸæé†’æ•°:', dueReminders.length);
          
          if (dueReminders.length === 0) {
            console.log('âœ… æ²¡æœ‰éœ€è¦å‘é€çš„æé†’');
            process.exit(0);
          }
          
          // ---------- å‘é€Telegramæ¶ˆæ¯ ----------
          async function sendTelegramMessages() {
            const sentResults = [];
            
            for (const reminder of dueReminders) {
              // è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
              const nextDate = new Date(TODAY);
              nextDate.setDate(nextDate.getDate() + reminder.days);
              const nextYear = nextDate.getFullYear();
              const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
              const nextDay = String(nextDate.getDate()).padStart(2, '0');
              const nextReminderStr = \`\${nextYear}-\${nextMonth}-\${nextDay}\`;
              
              // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒHTMLæ ¼å¼ï¼‰
              const message = \`
ğŸ”” <b>å®šæ—¶æé†’é€šçŸ¥</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ <b>ä»»åŠ¡åç§°</b>: \${reminder.name}
ğŸ“… <b>åˆ°æœŸæ—¥æœŸ</b>: \${reminder.nextReminder}
â³ <b>å‘¨æœŸ</b>: æ¯ \${reminder.days} å¤©
âœ… <b>ä¸Šæ¬¡å®Œæˆ</b>: \${reminder.lastUpdated || 'æ— '}
ğŸ”„ <b>ä¸‹æ¬¡æé†’</b>: \${nextReminderStr}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ è¯·åŠæ—¶å¤„ç†è¯¥ä»»åŠ¡ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° æ£€æŸ¥æ—¶é—´: ${{ env.BEIJING_TIME }}
ğŸ”— <a href='https://github.com/${{ github.repository }}/actions'>æŸ¥çœ‹è‡ªåŠ¨åŒ–æ—¥å¿—</a>
\`;
              
              const url = \`https://api.telegram.org/bot\${BOT_TOKEN}/sendMessage\`;
              
              try {
                const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: message,
                    parse_mode: 'HTML',
                    disable_web_page_preview: true
                  })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                  console.log('âœ… å‘é€æˆåŠŸ:', reminder.name);
                  // æ›´æ–°æé†’çŠ¶æ€
                  reminder.notified = true;
                  reminder.lastSentTime = new Date().toISOString();
                  // è‡ªåŠ¨æ›´æ–°ä¸‹æ¬¡æé†’æ—¥æœŸï¼ˆå¦‚æœç”¨æˆ·æ²¡ç‚¹å®Œæˆï¼Œä¸‹æ¬¡ç»§ç»­æé†’ï¼‰
                  // è¿™é‡Œä¸è‡ªåŠ¨æ¨è¿›æ—¥æœŸï¼Œä¿æŒæ¯å¤©æé†’ç›´åˆ°ç”¨æˆ·ç‚¹å‡»"è®¾ä¸ºä»Šå¤©"
                  sentResults.push({ name: reminder.name, success: true });
                } else {
                  console.error('âŒ å‘é€å¤±è´¥:', reminder.name, result.description);
                  sentResults.push({ name: reminder.name, success: false, error: result.description });
                }
              } catch (error) {
                console.error('âŒ ç½‘ç»œé”™è¯¯:', reminder.name, error.message);
                sentResults.push({ name: reminder.name, success: false, error: error.message });
              }
              
              // é¿å…è§¦å‘é¢‘ç‡é™åˆ¶
              await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            // ä¿å­˜æ›´æ–°åçš„æé†’æ•°æ®
            fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
            console.log('ğŸ’¾ å·²æ›´æ–°æé†’çŠ¶æ€å¹¶ä¿å­˜åˆ°æ–‡ä»¶');
            
            // è¾“å‡ºç»Ÿè®¡
            const successCount = sentResults.filter(r => r.success).length;
            console.log(\`ğŸ“Š å‘é€ç»Ÿè®¡: æˆåŠŸ \${successCount}/\${sentResults.length}\`);
          }
          
          sendTelegramMessages().catch(console.error);
          "

      - name: ğŸ’¾ æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥reminders.jsonæ˜¯å¦æœ‰å˜åŒ–
          git add reminders.json
          
          if ! git diff --quiet && ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: æé†’çŠ¶æ€åŒæ­¥ [$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: ğŸ“¢ å‘é€è¿è¡ŒçŠ¶æ€é€šçŸ¥
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… æˆåŠŸ"
          else
            STATUS="âŒ å¤±è´¥"
          fi
          
          # ä»…åœ¨å·¥ä½œæµå¤±è´¥æ—¶å‘é€é€šçŸ¥
          if [ "${{ job.status }}" != "success" ]; then
            node -e "
            const botToken = process.env.TELEGRAM_BOT_TOKEN;
            const chatId = process.env.TELEGRAM_CHAT_ID;
            const message = \`
âš ï¸ <b>GitHub Actions è¿è¡Œå¤±è´¥</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ ä»“åº“: ${{ github.repository }}
ğŸ”– å·¥ä½œæµ: ${{ github.workflow }}
â±ï¸ æ—¶é—´: ${{ env.BEIJING_TIME }}
âŒ çŠ¶æ€: ${{ job.status }}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a>
\`;
            
            fetch(\`https://api.telegram.org/bot\${botToken}/sendMessage\`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'HTML'
              })
            }).catch(e => console.error(e));
            "
          fi
