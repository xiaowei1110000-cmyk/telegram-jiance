name: å®šæ—¶æé†’ç³»ç»Ÿ

on:
  schedule:
    # æ¯3åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '*/3 * * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'reminders.json'

# å…³é”®ï¼šç»™äºˆå†™æƒé™
permissions:
  contents: write
  actions: read

jobs:
  check-reminders:
    runs-on: ubuntu-latest
    # å…³é”®ï¼šè®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™è¿è¡Œ
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
    
    - name: ğŸ•’ 2. è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
      run: |
        echo "TZ='Asia/Shanghai'" >> $GITHUB_ENV
        echo "BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "TODAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_ENV
    
    - name: ğŸ” 3. æ£€æŸ¥æé†’å¹¶å‘é€Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "â° åŒ—äº¬æ—¶é—´: ${{ env.BEIJING_TIME }}"
        echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: ${{ env.TODAY }}"
        
        # æ£€æŸ¥Telegramå‡­è¯
        if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
          echo "âŒ é”™è¯¯: æœªé…ç½®Telegramå‡­è¯"
          echo "è¯·åœ¨Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ :"
          echo "  - TELEGRAM_BOT_TOKEN: ä½ çš„Bot Token"
          echo "  - TELEGRAM_CHAT_ID: ç¾¤ç»„ID"
          exit 1
        fi
        
        # åˆ›å»ºNode.jsè„šæœ¬æ–‡ä»¶
        cat > check-reminder.js << 'EOF'
        const fs = require('fs');
        const https = require('https');

        // è·å–ç¯å¢ƒå˜é‡
        const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
        const CHAT_ID = process.env.TELEGRAM_CHAT_ID;
        const TODAY = process.env.TODAY;
        const REPO = process.env.GITHUB_REPOSITORY;
        const RUN_ID = process.env.GITHUB_RUN_ID;

        console.log('ğŸ¤– Bot Token:', BOT_TOKEN ? BOT_TOKEN.substring(0, 20) + '...' : 'æœªé…ç½®');
        console.log('ğŸ‘¥ Chat ID:', CHAT_ID);
        console.log('ğŸ“… ä»Šå¤©:', TODAY);

        // è¯»å–reminders.json
        let reminders = [];
        try {
          if (fs.existsSync('reminders.json')) {
            const content = fs.readFileSync('reminders.json', 'utf8');
            reminders = JSON.parse(content);
            console.log(`ğŸ“‹ åŠ è½½äº† ${reminders.length} ä¸ªæé†’`);
          } else {
            console.log('ğŸ“ reminders.json ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶');
            fs.writeFileSync('reminders.json', '[]');
          }
        } catch (e) {
          console.error('âŒ è¯»å–æ–‡ä»¶å¤±è´¥:', e.message);
          process.exit(1);
        }

        // ç­›é€‰ä»Šå¤©åˆ°æœŸçš„æé†’
        const dueReminders = reminders.filter(r => 
          r.enabled !== false && 
          r.nextReminder === TODAY &&
          r.notified !== true
        );

        console.log(`ğŸ”” ä»Šæ—¥åˆ°æœŸæé†’: ${dueReminders.length} ä¸ª`);

        if (dueReminders.length === 0) {
          console.log('âœ… æ²¡æœ‰éœ€è¦å‘é€çš„æé†’');
          process.exit(0);
        }

        // å‘é€Telegramæ¶ˆæ¯çš„å‡½æ•°
        function sendTelegramMessage(reminder) {
          return new Promise((resolve, reject) => {
            // è®¡ç®—ä¸‹æ¬¡æé†’æ—¥æœŸ
            const nextDate = new Date(TODAY);
            nextDate.setDate(nextDate.getDate() + reminder.days);
            const nextYear = nextDate.getFullYear();
            const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
            const nextDay = String(nextDate.getDate()).padStart(2, '0');
            const nextReminder = `${nextYear}-${nextMonth}-${nextDay}`;

            // æ„å»ºæ¶ˆæ¯
            const message = `ğŸ”” <b>å®šæ—¶æé†’é€šçŸ¥</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ <b>ä»»åŠ¡</b>: ${reminder.name}
ğŸ“… <b>åˆ°æœŸæ—¥</b>: ${reminder.nextReminder}
â³ <b>å‘¨æœŸ</b>: æ¯ ${reminder.days} å¤©
âœ… <b>ä¸Šæ¬¡å®Œæˆ</b>: ${reminder.lastUpdated || 'æ— '}
ğŸ”„ <b>ä¸‹æ¬¡æé†’</b>: ${nextReminder}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ è¯·åŠæ—¶å¤„ç†è¯¥ä»»åŠ¡ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° æ£€æŸ¥æ—¶é—´: ${process.env.BEIJING_TIME}
ğŸ”— <a href='https://github.com/${REPO}/actions/runs/${RUN_ID}'>æŸ¥çœ‹æ—¥å¿—</a>`;

            const postData = JSON.stringify({
              chat_id: CHAT_ID,
              text: message,
              parse_mode: 'HTML',
              disable_web_page_preview: true
            });

            const options = {
              hostname: 'api.telegram.org',
              path: `/bot${BOT_TOKEN}/sendMessage`,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };

            const req = https.request(options, (res) => {
              let data = '';
              res.on('data', (chunk) => data += chunk);
              res.on('end', () => {
                try {
                  const result = JSON.parse(data);
                  if (result.ok) {
                    console.log(`âœ… å‘é€æˆåŠŸ: ${reminder.name}`);
                    // æ›´æ–°æé†’çŠ¶æ€
                    reminder.notified = true;
                    reminder.lastSentTime = new Date().toISOString();
                    resolve(true);
                  } else {
                    console.error(`âŒ å‘é€å¤±è´¥: ${reminder.name}`, result.description);
                    resolve(false);
                  }
                } catch (e) {
                  reject(e);
                }
              });
            });

            req.on('error', reject);
            req.write(postData);
            req.end();
          });
        }

        // ä¾æ¬¡å‘é€æ‰€æœ‰æé†’
        async function main() {
          let successCount = 0;
          
          for (const reminder of dueReminders) {
            try {
              const success = await sendTelegramMessage(reminder);
              if (success) successCount++;
              // ç­‰å¾…1.5ç§’ï¼Œé¿å…è§¦å‘é¢‘ç‡é™åˆ¶
              await new Promise(r => setTimeout(r, 1500));
            } catch (e) {
              console.error(`âŒ ç½‘ç»œé”™è¯¯: ${reminder.name}`, e.message);
            }
          }

          // ä¿å­˜æ›´æ–°åçš„reminders.json
          fs.writeFileSync('reminders.json', JSON.stringify(reminders, null, 2));
          console.log(`ğŸ’¾ å·²æ›´æ–°æé†’çŠ¶æ€ï¼ŒæˆåŠŸ: ${successCount}/${dueReminders.length}`);
          
          if (successCount > 0) {
            // è®¾ç½®è¾“å‡ºå˜é‡ï¼Œç”¨äºåç»­æ­¥éª¤
            fs.writeFileSync('has-updates.txt', 'true');
          }
        }

        main().catch(console.error);
        EOF

        # æ‰§è¡ŒNode.jsè„šæœ¬
        node check-reminder.js
    
    - name: ğŸ’¾ 4. æäº¤æ›´æ–°åˆ°ä»“åº“
      if: success()
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        git add reminders.json
        
        if ! git diff --quiet && ! git diff --staged --quiet; then
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: æé†’çŠ¶æ€åŒæ­¥ [$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')]"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
    
    - name: ğŸ“¢ 5. å‘é€å¤±è´¥é€šçŸ¥ï¼ˆä»…å½“å·¥ä½œæµå¤±è´¥æ—¶ï¼‰
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        node -e "
        const https = require('https');
        const botToken = process.env.TELEGRAM_BOT_TOKEN;
        const chatId = process.env.TELEGRAM_CHAT_ID;
        
        if (!botToken || !chatId) {
          console.log('âš ï¸ æœªé…ç½®Telegramï¼Œè·³è¿‡å¤±è´¥é€šçŸ¥');
          process.exit(0);
        }
        
        const message = \`âš ï¸ <b>GitHub Actions è¿è¡Œå¤±è´¥</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ ä»“åº“: ${{ github.repository }}
ğŸ”– å·¥ä½œæµ: ${{ github.workflow }}
â±ï¸ æ—¶é—´: ${{ env.BEIJING_TIME }}
âŒ çŠ¶æ€: ${{ job.status }}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a>\`;
        
        const postData = JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: 'HTML'
        });
        
        const options = {
          hostname: 'api.telegram.org',
          path: \`/bot\${botToken}/sendMessage\`,
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Content-Length': Buffer.byteLength(postData)
          }
        };
        
        const req = https.request(options, (res) => {
          console.log('ğŸ“¤ å¤±è´¥é€šçŸ¥å‘é€çŠ¶æ€:', res.statusCode);
        });
        
        req.on('error', (e) => console.error('âŒ å‘é€å¤±è´¥é€šçŸ¥å‡ºé”™:', e.message));
        req.write(postData);
        req.end();
        "
