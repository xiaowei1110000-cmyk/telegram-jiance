name: å®šæ—¶æ£€æŸ¥æé†’å¹¶å‘é€é€šçŸ¥

on:
  schedule:
    - cron: '*/3 * * * *'  # æ¯3åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-reminders:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check and Send Reminders
        run: |
          # è¯»å–æé†’æ•°æ®
          if [ ! -f reminders.json ]; then
            echo "âŒ reminders.json ä¸å­˜åœ¨"
            exit 0
          fi

          # è·å–ä»Šå¤©æ—¥æœŸ (UTC+8)
          TODAY=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          echo "ğŸ“… ä»Šå¤©: $TODAY"

          BOT_TOKEN="8239139638:AAGbCCpa6Jei3bviOv7uNjMTRAdxJ_4VXG0"
          CHAT_ID="-1003549797288"

          UPDATED=false

          # ç”¨ jq éå†æé†’
          LENGTH=$(jq length reminders.json)
          for i in $(seq 0 $(($LENGTH - 1))); do
            NAME=$(jq -r ".[$i].name" reminders.json)
            NEXT=$(jq -r ".[$i].nextReminder" reminders.json)
            NOTIFIED=$(jq -r ".[$i].notified" reminders.json)
            ENABLED=$(jq -r ".[$i].enabled" reminders.json)
            DAYS=$(jq -r ".[$i].days" reminders.json)

            echo "æ£€æŸ¥: $NAME | ä¸‹æ¬¡: $NEXT | å·²é€šçŸ¥: $NOTIFIED"

            # åˆ¤æ–­æ˜¯å¦åˆ°æœŸä¸”æœªé€šçŸ¥
            if [ "$ENABLED" = "true" ] && [ "$NEXT" \<= "$TODAY" ] && [ "$NOTIFIED" != "true" ]; then
              echo "â° å‘é€æé†’: $NAME"

              MESSAGE="â° *å®šæ—¶æé†’åˆ°æœŸ*%0A%0AğŸ“Œ *${NAME}*%0AğŸ“… åˆ°æœŸæ—¥æœŸ: ${NEXT}%0AğŸ”„ é—´éš”: ${DAYS}å¤©%0A%0Aè¯·åŠæ—¶å¤„ç†ï¼"

              curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                -d "chat_id=${CHAT_ID}" \
                -d "text=${MESSAGE}" \
                -d "parse_mode=Markdown"

              # æ ‡è®°ä¸ºå·²é€šçŸ¥
              CURRENT_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              jq ".[$i].notified = true | .[$i].lastSentTime = \"$CURRENT_TIME\"" reminders.json > tmp.json && mv tmp.json reminders.json
              UPDATED=true

              echo "âœ… å·²å‘é€: $NAME"
            fi
          done

          # å¦‚æœæœ‰æ›´æ–°ï¼Œæäº¤å›ä»“åº“
          if [ "$UPDATED" = "true" ]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add reminders.json
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°é€šçŸ¥çŠ¶æ€ - $TODAY"
            git push
            echo "ğŸ“¤ å·²æ¨é€æ›´æ–°"
          else
            echo "âœ… æ— éœ€å‘é€é€šçŸ¥"
          fi
